<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ClearMap.Alignment.Resampling &mdash; ClearMap 0.9.2 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/clearmap.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.9.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="top" title="ClearMap 0.9.2 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
 
    <script type="text/javascript">
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>


  </head>
  <body role="document">
<div style="background-color: #e2e8e9; text-align: left; padding: 10px 10px 15px 15px">
<p style="font-size: 30px; color: color: #11557C"> <a href="../../../index.html" style="color: #11557C; font-weight: bold">ClearMap iDISCO+ Toolbox Documentation</a></p>
<a href="../../../index.html"><img src="../../../_static/brain_bw_small.jpg" height=50px width=150% border="0" alt="ClearMap"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
       <li><a href="../../../index.html">home</a>|&nbsp;</li>
       <li><a href="../../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../../api/ClearMap.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Overview of ClearMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../imageanalysis.html">ClearMap Image Analysis Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../issues.html">Issues</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/ClearMap.html">ClearMap package</a></li>
</ul>
 
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ClearMap.Alignment.Resampling</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The *Resampling* module provides methods to resample and reorient volumetric </span>
<span class="sd">and point data. </span>

<span class="sd">Resampling the data is usually necessary as the first step to match the </span>
<span class="sd">resolution and orientation of the reference object. </span>

<span class="sd">Main routines for resampling are: :func:`~ClearMap.Alignment.Resampling.resampleData` </span>
<span class="sd">and :func:`~ClearMap.Alignment.Resampling.resamplePoints`.</span>


<span class="sd">Image Representation and Size</span>
<span class="sd">-----------------------------</span>
<span class="sd">The module assumes that images in arrays are arranged as </span>

<span class="sd">    * [x,y] or </span>
<span class="sd">    * [x,y,z] </span>

<span class="sd">where x,y,z correspond to the x,y,z coordinates as displayed in e.g. ImageJ. </span>
<span class="sd">For example an image of size (512,512) stored in an array ``img`` will have:</span>

<span class="sd">    &gt;&gt;&gt; img.shape</span>
<span class="sd">    (512,512)</span>

<span class="sd">Points are assumed to be given as x,y,z coordinates</span>

<span class="sd">Parameters such as *resolution* or *dataSize* are assumed to be given in (x,y)</span>
<span class="sd">or (x,y,z) format, e.g.</span>

<span class="sd">    &gt;&gt;&gt; dataSize = (512,512)</span>

<span class="sd">Orientation</span>
<span class="sd">-----------</span>

<span class="sd">The *orientation* parameter is a tuple of d numbers from 1 to d that specifies </span>
<span class="sd">the permutation of the axes, a minus sign infront of a numbeer indicates</span>
<span class="sd">inversion of that axes. For exmaple </span>

<span class="sd">    &gt;&gt;&gt; orientation=(2,-1) </span>

<span class="sd">indicates that x and y should be exchanged and the new y axes should be reversed.</span>

<span class="sd">Generally a re-orientation is composed of first a permutation of the axes and then</span>
<span class="sd">inverting the indicated axes.</span>

<span class="sd">A *permutation* is an orientation without signs and with numbers from 0 to d-1.</span>



<span class="sd">Examples:</span>
<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; import ClearMap.IO as io</span>
<span class="sd">    &gt;&gt;&gt; from ClearMap.Settings import ClearMapPath  </span>
<span class="sd">    &gt;&gt;&gt; from ClearMap.Alignment.Resampling import resampleData</span>
<span class="sd">    &gt;&gt;&gt; filename = os.path.join(ClearMapPath,&#39;Test/Data/OME/16-17-27_0_8X-s3-20HF_UltraII_C00_xyz-Table Z\d{4}.ome.tif&#39;);</span>
<span class="sd">    &gt;&gt;&gt; print io.dataSize(filename)</span>
<span class="sd">    (2160, 2560, 21)</span>
<span class="sd">    &gt;&gt;&gt; data = resampleData(filename, sink = None, resolutionSource = (1,1,1), orientation = (1,2,3), resolutionSink = (10,10,2));</span>
<span class="sd">    &gt;&gt;&gt; print data.shape</span>
<span class="sd">    (216, 256, 10)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c">#:copyright: Copyright 2015 by Christoph Kirst, The Rockefeller University, New York City</span>
<span class="c">#:license: GNU, see LICENSE.txt for details.</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>  
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="c">#import matplotlib.pyplot as plt</span>

<span class="kn">import</span> <span class="nn">ClearMap.IO.IO</span> <span class="kn">as</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">ClearMap.IO.FileList</span> <span class="kn">as</span> <span class="nn">fl</span>

<span class="kn">from</span> <span class="nn">ClearMap.Utils.ProcessWriter</span> <span class="kn">import</span> <span class="n">ProcessWriter</span><span class="p">;</span>


<div class="viewcode-block" id="fixOrientation"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.fixOrientation">[docs]</a><span class="k">def</span> <span class="nf">fixOrientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert orientation to standard format number sequence</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        orientation (tuple or str): orientation specification</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: orientation sequence</span>
<span class="sd">    </span>
<span class="sd">    See Also:</span>
<span class="sd">        `Orientation`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">;</span>
        
    <span class="c">#fix named representations</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s">&#39;Left&#39;</span><span class="p">:</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s">&#39;Right&#39;</span><span class="p">:</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>    
    
    <span class="k">return</span> <span class="n">orientation</span><span class="p">;</span></div>


<div class="viewcode-block" id="inverseOrientation"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.inverseOrientation">[docs]</a><span class="k">def</span> <span class="nf">inverseOrientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the inverse permuation of the permutation orientation taking axis inversions into account.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        orientation (tuple or str): orientation specification</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: orientation sequence</span>
<span class="sd">        </span>
<span class="sd">    See Also:</span>
<span class="sd">        `Orientation`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">;</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>
    <span class="n">iper</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>
    
    <span class="c">#permutation is defined as permuting the axes and then axis inversion</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">orientation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">iper</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">orientation</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iper</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">orientation</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">iper</span><span class="p">)</span></div>


<div class="viewcode-block" id="orientationToPermuation"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.orientationToPermuation">[docs]</a><span class="k">def</span> <span class="nf">orientationToPermuation</span><span class="p">(</span><span class="n">orientation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extracts the permuation from an orientation.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        orientation (tuple or str): orientation specification</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: premutation sequence</span>
<span class="sd">        </span>
<span class="sd">    See Also:</span>
<span class="sd">        `Orientation`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orientation</span> <span class="o">=</span> <span class="n">fixOrientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">orientation</span><span class="p">);</span></div>


<div class="viewcode-block" id="orientResolution"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.orientResolution">[docs]</a><span class="k">def</span> <span class="nf">orientResolution</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">orientation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Permutes a resolution tuple according to the given orientation.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        resolution (tuple): resolution specification</span>
<span class="sd">        orientation (tuple or str): orientation specification</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: oriented resolution sequence</span>
<span class="sd">        </span>
<span class="sd">    See Also:</span>
<span class="sd">        `Orientation`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">;</span>
    
    <span class="n">per</span> <span class="o">=</span> <span class="n">orientationToPermuation</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>
    <span class="c">#print orientation, per, resolution</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">resolution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">per</span><span class="p">);</span></div>
    

<div class="viewcode-block" id="orientResolutionInverse"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.orientResolutionInverse">[docs]</a><span class="k">def</span> <span class="nf">orientResolutionInverse</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">orientation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Permutes a resolution tuple according to the inverse of a given orientation.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        resolution (tuple): resolution specification</span>
<span class="sd">        orientation (tuple or str): orientation specification</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: oriented resolution sequence</span>
<span class="sd">        </span>
<span class="sd">    See Also:</span>
<span class="sd">        `Orientation`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">;</span>
    
    <span class="n">per</span> <span class="o">=</span> <span class="n">orientationToPermuation</span><span class="p">(</span><span class="n">inverseOrientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">));</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">resolution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">per</span><span class="p">);</span></div>

 
<div class="viewcode-block" id="orientDataSize"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.orientDataSize">[docs]</a><span class="k">def</span> <span class="nf">orientDataSize</span><span class="p">(</span><span class="n">dataSize</span><span class="p">,</span> <span class="n">orientation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Permutes a data size tuple according to the given orientation.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        dataSize (tuple): resolution specification</span>
<span class="sd">        orientation (tuple or str): orientation specification</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: oriented dataSize sequence</span>
<span class="sd">        </span>
<span class="sd">    See Also:</span>
<span class="sd">        `Orientation`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">orientResolution</span><span class="p">(</span><span class="n">dataSize</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span></div>
 
<div class="viewcode-block" id="orientDataSizeInverse"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.orientDataSizeInverse">[docs]</a><span class="k">def</span> <span class="nf">orientDataSizeInverse</span><span class="p">(</span><span class="n">dataSize</span><span class="p">,</span> <span class="n">orientation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Permutes a dataSize tuple according to the inverse of a given orientation.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        dataSize (tuple): dataSize specification</span>
<span class="sd">        orientation (tuple or str): orientation specification</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: oriented dataSize sequence</span>
<span class="sd">        </span>
<span class="sd">    See Also:</span>
<span class="sd">        `Orientation`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">orientResolutionInverse</span><span class="p">(</span><span class="n">dataSize</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span> </div>
 
 
<div class="viewcode-block" id="resampleDataSize"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.resampleDataSize">[docs]</a><span class="k">def</span> <span class="nf">resampleDataSize</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">resolutionSource</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate scaling factors and data sizes for resampling.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        dataSizeSource (tuple): data size of the original image</span>
<span class="sd">        dataSizeSink (tuple or None): data size of the resmapled image</span>
<span class="sd">        resolutionSource (tuple or None): resolution of the source image</span>
<span class="sd">        resolutionSink (tuple or None): resolution of the sink image</span>
<span class="sd">        orientation (tuple or str): re-orientation specification</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: data size of the source</span>
<span class="sd">        tuple: data size of the sink</span>
<span class="sd">        tuple: resolution of source</span>
<span class="sd">        tuple: resolution of sink</span>
<span class="sd">    </span>
<span class="sd">    See Also:</span>
<span class="sd">        `Orientation`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">orientation</span> <span class="o">=</span> <span class="n">fixOrientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>    
    
    <span class="c">#determine data sizes if not specified</span>
    <span class="k">if</span> <span class="n">dataSizeSink</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">resolutionSource</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">resolutionSink</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;resampleDataSize: data size and resolutions not defined!&#39;</span><span class="p">);</span>
        
        <span class="c">#orient resolution of source to resolution of sink to get sink data size</span>
        <span class="n">resolutionSourceO</span> <span class="o">=</span> <span class="n">orientResolution</span><span class="p">(</span><span class="n">resolutionSource</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span>
        <span class="n">dataSizeSourceO</span> <span class="o">=</span> <span class="n">orientDataSize</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span>
        
        <span class="c">#calculate scaling factor</span>
        <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dataSizeSourceO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span>  <span class="n">resolutionSourceO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">resolutionSink</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">))]);</span>        
        
    <span class="c">#print dataSizeSink, &quot;ds sink&quot;</span>
    
    <span class="k">if</span> <span class="n">dataSizeSource</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">resolutionSource</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">resolutionSink</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;resampleDataSize: data size and resolutions not defined!&#39;</span><span class="p">);</span>
        
        <span class="c">#orient resolution of source to resolution of sink to get sink data size</span>
        <span class="n">resolutionSourceO</span> <span class="o">=</span> <span class="n">orientResolution</span><span class="p">(</span><span class="n">resolutionSource</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span>
        
        <span class="c">#calculate source data size</span>
        <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dataSizeSink</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span>  <span class="n">resolutionSink</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">resolutionSourceO</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataSizeSink</span><span class="p">))]);</span>  
        <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">orientDataSizeInverse</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">);</span>
        
    <span class="c">#print dataSizeSource, &quot;ds source&quot;</span>
        
    <span class="c">#calculate effecive resolutions</span>
    <span class="k">if</span> <span class="n">resolutionSource</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">resolutionSink</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">resolutionSource</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataSizeSourceO</span> <span class="o">=</span> <span class="n">orientDataSize</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span>
            <span class="n">resolutionSource</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dataSizeSink</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">dataSizeSourceO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">resolutionSink</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">)));</span>
            <span class="n">resolutionSource</span> <span class="o">=</span> <span class="n">orientResolutionInverse</span><span class="p">(</span><span class="n">resolutionSource</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span>
    
    <span class="c">#print resolutionSource, &quot;res source sink&quot;</span>
    
    <span class="n">dataSizeSourceO</span> <span class="o">=</span> <span class="n">orientDataSize</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span>
    
    
    <span class="n">resolutionSourceO</span> <span class="o">=</span> <span class="n">orientResolution</span><span class="p">(</span><span class="n">resolutionSource</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span>
    <span class="n">resolutionSink</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dataSizeSourceO</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">dataSizeSink</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">resolutionSourceO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">)));</span>
    
    <span class="c">#print dataSizeSource, dataSizeSink, resolutionSource, resolutionSink </span>
    
    <span class="k">return</span> <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">resolutionSource</span><span class="p">,</span> <span class="n">resolutionSink</span>  </div>




<div class="viewcode-block" id="fixInterpolation"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.fixInterpolation">[docs]</a><span class="k">def</span> <span class="nf">fixInterpolation</span><span class="p">(</span><span class="n">interpolation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts interpolation given as string to cv2 interpolation object</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        interpolation (str or object): interpolation string or cv2 object</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        object: cv2 interpolation type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s">&#39;nn&#39;</span> <span class="ow">or</span> <span class="n">interpolation</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">:</span>
        <span class="n">interpolation</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">interpolation</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">;</span>
        
    <span class="k">return</span> <span class="n">interpolation</span><span class="p">;</span></div>
        


<div class="viewcode-block" id="resampleXY"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.resampleXY">[docs]</a><span class="k">def</span> <span class="nf">resampleXY</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="s">&#39;linear&#39;</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resample a 2d image slice</span>
<span class="sd">    </span>
<span class="sd">    This routine is used for resampling a large stack in parallel in xy or xz direction.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        source (str or array): 2d image source</span>
<span class="sd">        dataSizeSink (tuple): size of the resmapled image</span>
<span class="sd">        sink (str or None): location for the resmapled image</span>
<span class="sd">        interpolation (str): interpolation method to use: &#39;linear&#39; or None (nearest pixel)</span>
<span class="sd">        out (stdout): where to write progress information</span>
<span class="sd">        vebose (bool): write progress info if true</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        array or str: resampled data or file name</span>
<span class="sd">    &quot;&quot;&quot;</span>   
    
    <span class="c">#out.write(&quot;Input: %s Output: &quot; % (inputFile, soutputFile))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readData</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
    <span class="n">dataSize</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
    
    <span class="c">#print dataSize, dataSizeSink    </span>
    
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;resampleXY: expects 2d image source, found </span><span class="si">%d</span><span class="s">d&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
    <span class="c">#print sagittalImageSize;</span>
    
    <span class="c">#dataSizeSink = tuple([int(math.ceil(dataSize[i] *  resolutionSource[i]/resolutionSink[i])) for i in range(2)]);</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s">&quot;resampleData: Imagesize: </span><span class="si">%d</span><span class="s">, </span><span class="si">%d</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataSize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dataSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;Resampled Imagesize: </span><span class="si">%d</span><span class="s">, </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataSizeSink</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dataSizeSink</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="c">#out.write((&quot;resampleData: Imagesize: %d, %d &quot; % dataSize) + (&quot;Resampled Imagesize: %d, %d&quot; % (outputSize[1], outputSize[0])))</span>
    
    <span class="c"># note: cv2.resize reverses x-Y axes</span>
    <span class="n">interpolation</span> <span class="o">=</span> <span class="n">fixInterpolation</span><span class="p">(</span><span class="n">interpolation</span><span class="p">)</span>
    <span class="n">sinkData</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>  <span class="p">(</span><span class="n">dataSizeSink</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dataSizeSink</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">);</span>
    <span class="c">#sinkData = cv2.resize(data,  outputSize);</span>
    <span class="c">#sinkData = scipy.misc.imresize(sagittalImage, outputImageSize, interp = &#39;bilinear&#39;); #normalizes images -&gt; not usefull for stacks !</span>
    
    <span class="c">#out.write(&quot;resampleData: resized Image size: %d, %d &quot; % sinkData.shape)</span>
    
    <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">writeData</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">sinkData</span><span class="p">);</span></div>


<span class="k">def</span> <span class="nf">_resampleXYParallel</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resampling helper function to use for parallel resampling of image slices&quot;&quot;&quot;</span>
    
    <span class="n">fileSource</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">fileSink</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">interpolation</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
    
    <span class="n">pw</span> <span class="o">=</span> <span class="n">ProcessWriter</span><span class="p">(</span><span class="n">ii</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">pw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;resampleData: resampling in XY: image </span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nn</span><span class="p">))</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">readData</span><span class="p">(</span><span class="n">fileSource</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">ii</span><span class="p">));</span>
    <span class="n">resampleXY</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">fileSink</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">pw</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">);</span>




<div class="viewcode-block" id="resampleData"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.resampleData">[docs]</a><span class="k">def</span> <span class="nf">resampleData</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="n">orientation</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">resolutionSource</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0625</span><span class="p">,</span> <span class="mf">4.0625</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> 
                 <span class="n">processingDirectory</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cleanup</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="s">&#39;linear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resample data of source in resolution and orientation</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        source (str or array): image to be resampled</span>
<span class="sd">        sink (str or None): destination of resampled image</span>
<span class="sd">        orientation (tuple): orientation specified by permuation and change in sign of (1,2,3)</span>
<span class="sd">        dataSizeSink (tuple or None): target size of the resampled image</span>
<span class="sd">        resolutionSource (tuple): resolution of the source image (in length per pixel)</span>
<span class="sd">        resolutionSink (tuple): resolution of the resampled image (in length per pixel)</span>
<span class="sd">        processingDirectory (str or None): directory in which to perform resmapling in parallel, None a temporary directry will be created</span>
<span class="sd">        processes (int): number of processes to use for parallel resampling</span>
<span class="sd">        cleanup (bool): remove temporary files</span>
<span class="sd">        verbose (bool): display progress information</span>
<span class="sd">        interpolation (str): method to use for interpolating to the resmapled image</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        (array or str): data or file name of resampled image</span>

<span class="sd">    Notes: </span>
<span class="sd">        * resolutions are assumed to be given for the axes of the intrinsic </span>
<span class="sd">          orientation of the data and reference as when viewed by matplotlib or ImageJ</span>
<span class="sd">        * orientation: permuation of 1,2,3 with potential sign, indicating which </span>
<span class="sd">          axes map onto the reference axes, a negative sign indicates reversal </span>
<span class="sd">          of that particular axes</span>
<span class="sd">        * only a minimal set of information to detremine the resampling parameter </span>
<span class="sd">          has to be given, e.g. dataSizeSource and dataSizeSink</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="n">orientation</span> <span class="o">=</span> <span class="n">fixOrientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataSizeSink</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">dataSize</span><span class="p">(</span><span class="n">dataSizeSink</span><span class="p">);</span>

    <span class="c">#orient actual resolutions onto reference resolution    </span>
    <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">dataSize</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
        
    <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">resolutionSource</span><span class="p">,</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="n">resampleDataSize</span><span class="p">(</span><span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="n">dataSizeSink</span><span class="p">,</span> 
                                                                                      <span class="n">resolutionSource</span> <span class="o">=</span> <span class="n">resolutionSource</span><span class="p">,</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="n">resolutionSink</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="n">orientation</span><span class="p">);</span>
    
    <span class="n">dataSizeSinkI</span> <span class="o">=</span> <span class="n">orientDataSizeInverse</span><span class="p">(</span><span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span>
    
    <span class="c">#print dataSizeSource, dataSizeSink, resolutionSource, resolutionSink, dataSizeSinkI</span>
    
     
    <span class="c">#rescale in x y in parallel</span>
    <span class="k">if</span> <span class="n">processingDirectory</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">processingDirectory</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">();</span>     
        
    <span class="n">interpolation</span> <span class="o">=</span> <span class="n">fixInterpolation</span><span class="p">(</span><span class="n">interpolation</span><span class="p">);</span>
     
    <span class="n">nZ</span> <span class="o">=</span> <span class="n">dataSizeSource</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">processes</span><span class="p">);</span>
    <span class="n">argdata</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nZ</span><span class="p">):</span>
        <span class="n">argdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processingDirectory</span><span class="p">,</span> <span class="s">&#39;resample_</span><span class="si">%04d</span><span class="s">.tif&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">),</span> <span class="n">dataSizeSinkI</span><span class="p">,</span> <span class="n">interpolation</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">nZ</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span> <span class="p">);</span>  
        <span class="c">#print argdata[i]</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_resampleXYParallel</span><span class="p">,</span> <span class="n">argdata</span><span class="p">);</span>
    
    <span class="c">#rescale in z</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processingDirectory</span><span class="p">,</span> <span class="s">&#39;resample_</span><span class="si">%04d</span><span class="s">.tif&#39;</span> <span class="o">%</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readData</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
    <span class="n">zImage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dataSizeSinkI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dataSizeSinkI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nZ</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">);</span>    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nZ</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;resampleData; reading </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">nZ</span><span class="p">);</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processingDirectory</span><span class="p">,</span> <span class="s">&#39;resample_</span><span class="si">%04d</span><span class="s">.tif&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">zImage</span><span class="p">[:,:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readData</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>

    
    <span class="n">resampledData</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dataSizeSinkI</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">zImage</span><span class="o">.</span><span class="n">dtype</span><span class="p">);</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataSizeSinkI</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">25</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;resampleData: processing </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dataSizeSinkI</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c">#resampledImage[:, iImage ,:] =  scipy.misc.imresize(zImage[:,iImage,:], [resizedZAxisSize, sagittalImageSize[1]] , interp = &#39;bilinear&#39;); </span>
        <span class="c">#cv2.resize takes reverse order of sizes !</span>
        <span class="n">resampledData</span><span class="p">[</span><span class="n">i</span> <span class="p">,:,</span> <span class="p">:]</span> <span class="o">=</span>  <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">zImage</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="p">(</span><span class="n">dataSizeSinkI</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dataSizeSinkI</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">);</span>
        <span class="c">#resampledData[i ,:, :] =  cv2.resize(zImage[i,:, :], (dataSize[1], resizedZSize));</span>
    

    <span class="c">#account for using (z,y,x) array representation -&gt; (y,x,z)</span>
    <span class="c">#resampledData = resampledData.transpose([1,2,0]);</span>
    <span class="c">#resampledData = resampledData.transpose([2,1,0]);</span>
    
    <span class="k">if</span> <span class="n">cleanup</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">processingDirectory</span><span class="p">);</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        
        <span class="c">#reorient</span>
        <span class="n">per</span> <span class="o">=</span> <span class="n">orientationToPermuation</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>
        <span class="n">resampledData</span> <span class="o">=</span> <span class="n">resampledData</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">per</span><span class="p">);</span>
    
        <span class="c">#reverse orientation after permuting e.g. (-2,1) brings axis 2 to first axis and we can reorder there</span>
        <span class="k">if</span> <span class="n">orientation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">resampledData</span> <span class="o">=</span> <span class="n">resampledData</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:];</span>
        <span class="k">if</span> <span class="n">orientation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">resampledData</span> <span class="o">=</span> <span class="n">resampledData</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:];</span> 
        <span class="k">if</span> <span class="n">orientation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">resampledData</span> <span class="o">=</span> <span class="n">resampledData</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
        
        <span class="c">#bring back from y,x,z to z,y,x</span>
        <span class="c">#resampledImage = resampledImage.transpose([2,0,1]);</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;resampleData: resampled data size: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resampledData</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  
    
    <span class="k">if</span> <span class="n">sink</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="n">io</span><span class="o">.</span><span class="n">isFileExpression</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="n">sink</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
            <span class="n">sink</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sink</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;resample_\d{4}.tif&#39;</span><span class="p">);</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">sink</span> <span class="o">=</span> <span class="n">source</span> <span class="o">+</span> <span class="s">&#39;_resample.tif&#39;</span><span class="p">;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;resampleData: automatic sink naming not supported for non string source!&#39;</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">writeData</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">resampledData</span><span class="p">);</span></div>
    
    
    


<div class="viewcode-block" id="resampleDataInverse"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.resampleDataInverse">[docs]</a><span class="k">def</span> <span class="nf">resampleDataInverse</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">resolutionSource</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0625</span><span class="p">,</span> <span class="mf">4.0625</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> 
                        <span class="n">processingDirectory</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cleanup</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="s">&#39;linear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resample data inversely to :func:`resampleData` routine</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        sink (str or None): image to be inversly resampled (=sink in :func:`resampleData`)</span>
<span class="sd">        source (str or array): destination for inversly resmapled image (=source in :func:`resampleData`)</span>
<span class="sd">        dataSizeSource (tuple or None): target size of the resampled image</span>
<span class="sd">        orientation (tuple): orientation specified by permuation and change in sign of (1,2,3)</span>
<span class="sd">        resolutionSource (tuple): resolution of the source image (in length per pixel)</span>
<span class="sd">        resolutionSink (tuple): resolution of the resampled image (in length per pixel)</span>
<span class="sd">        processingDirectory (str or None): directory in which to perform resmapling in parallel, None a temporary directry will be created</span>
<span class="sd">        processes (int): number of processes to use for parallel resampling</span>
<span class="sd">        cleanup (bool): remove temporary files</span>
<span class="sd">        verbose (bool): display progress information</span>
<span class="sd">        interpolation (str): method to use for interpolating to the resmapled image</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        (array or str): data or file name of resampled image</span>

<span class="sd">    Notes: </span>
<span class="sd">        * resolutions are assumed to be given for the axes of the intrinsic </span>
<span class="sd">          orientation of the data and reference as when viewed by matplotlib or ImageJ</span>
<span class="sd">        * orientation: permuation of 1,2,3 with potential sign, indicating which </span>
<span class="sd">          axes map onto the reference axes, a negative sign indicates reversal </span>
<span class="sd">          of that particular axes</span>
<span class="sd">        * only a minimal set of information to detremine the resampling parameter </span>
<span class="sd">          has to be given, e.g. dataSizeSource and dataSizeSink</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    
    
    <span class="c">#orientation</span>
    <span class="n">orientation</span> <span class="o">=</span> <span class="n">fixOrientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>
    
    <span class="c">#assume we can read data fully into memory</span>
    <span class="n">resampledData</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readData</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>

    <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="n">resampledData</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">dataSize</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">);</span>

    <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">resolutionSource</span><span class="p">,</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="n">resampleDataSize</span><span class="p">(</span><span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="n">dataSizeSink</span><span class="p">,</span> 
                                                                                      <span class="n">resolutionSource</span> <span class="o">=</span> <span class="n">resolutionSource</span><span class="p">,</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="n">resolutionSink</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="n">orientation</span><span class="p">);</span>

    <span class="c">#print (dataSizeSource, dataSizeSink, resolutionSource, resolutionSink )</span>
    
    <span class="n">dataSizeSinkI</span> <span class="o">=</span> <span class="n">orientDataSizeInverse</span><span class="p">(</span><span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span>
    
    
    <span class="c">#flip axes back and permute inversely</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">orientation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">resampledData</span> <span class="o">=</span> <span class="n">resampledData</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:];</span>
        <span class="k">if</span> <span class="n">orientation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">resampledData</span> <span class="o">=</span> <span class="n">resampledData</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:];</span> 
        <span class="k">if</span> <span class="n">orientation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">resampledData</span> <span class="o">=</span> <span class="n">resampledData</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

        
        <span class="c">#reorient</span>
        <span class="n">peri</span> <span class="o">=</span> <span class="n">inverseOrientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>
        <span class="n">peri</span> <span class="o">=</span> <span class="n">orientationToPermuation</span><span class="p">(</span><span class="n">peri</span><span class="p">);</span>
        <span class="n">resampledData</span> <span class="o">=</span> <span class="n">resampledData</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">peri</span><span class="p">);</span>
    
    <span class="c"># upscale in z</span>
    <span class="n">interpolation</span> <span class="o">=</span> <span class="n">fixInterpolation</span><span class="p">(</span><span class="n">interpolation</span><span class="p">);</span>
    
    <span class="n">resampledDataXY</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dataSizeSinkI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dataSizeSinkI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dataSizeSource</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">resampledData</span><span class="o">.</span><span class="n">dtype</span><span class="p">);</span>    
    <span class="n">fileExperssionToFileName</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataSizeSinkI</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">25</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;resampleDataInverse: processing </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dataSizeSinkI</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c">#cv2.resize takes reverse order of sizes !</span>
        <span class="n">resampledDataXY</span><span class="p">[</span><span class="n">i</span> <span class="p">,:,</span> <span class="p">:]</span> <span class="o">=</span>  <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">resampledData</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="p">(</span><span class="n">dataSizeSource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dataSizeSinkI</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">);</span>

    <span class="c"># upscale x, y in parallel</span>
    
    <span class="k">if</span> <span class="n">io</span><span class="o">.</span><span class="n">isFileExpression</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">processingDirectory</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">processingDirectory</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">();</span>   
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sink</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;resample_\d{4}.tif&#39;</span><span class="p">);</span>
    
    <span class="n">io</span><span class="o">.</span><span class="n">writeData</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">resampledDataXY</span><span class="p">);</span>
    
    <span class="n">nZ</span> <span class="o">=</span> <span class="n">dataSizeSource</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">processes</span><span class="p">);</span>
    <span class="n">argdata</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nZ</span><span class="p">):</span>
        <span class="n">argdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">fl</span><span class="o">.</span><span class="n">fileExpressionToFileName</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">interpolation</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">nZ</span><span class="p">)</span> <span class="p">);</span>  
    <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_resampleXYParallel</span><span class="p">,</span> <span class="n">argdata</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="n">io</span><span class="o">.</span><span class="n">isFileExpression</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">convertData</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="n">cleanup</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">processingDirectory</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="n">data</span><span class="p">;</span></div>
    



<div class="viewcode-block" id="resamplePoints"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.resamplePoints">[docs]</a><span class="k">def</span> <span class="nf">resamplePoints</span><span class="p">(</span><span class="n">pointSource</span><span class="p">,</span> <span class="n">pointSink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">resolutionSource</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0625</span><span class="p">,</span> <span class="mf">4.0625</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resample Points to map from original data to the coordinates of the resampled image</span>
<span class="sd">    </span>
<span class="sd">    The resampling of points here corresponds to he resampling of an image in :func:`resampleData`</span>
<span class="sd">        </span>
<span class="sd">    Arguments:</span>
<span class="sd">        pointSource (str or array): image to be resampled</span>
<span class="sd">        pointSink (str or None): destination of resampled image</span>
<span class="sd">        orientation (tuple): orientation specified by permuation and change in sign of (1,2,3)</span>
<span class="sd">        dataSizeSource (str, tuple or None): size of the data source</span>
<span class="sd">        dataSizeSink (str, tuple or None): target size of the resampled image</span>
<span class="sd">        resolutionSource (tuple): resolution of the source image (in length per pixel)</span>
<span class="sd">        resolutionSink (tuple): resolution of the resampled image (in length per pixel)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        (array or str): data or file name of resampled points</span>

<span class="sd">    Notes: </span>
<span class="sd">        * resolutions are assumed to be given for the axes of the intrinsic </span>
<span class="sd">          orientation of the data and reference as when viewed by matplotlib or ImageJ</span>
<span class="sd">        * orientation: permuation of 1,2,3 with potential sign, indicating which </span>
<span class="sd">          axes map onto the reference axes, a negative sign indicates reversal </span>
<span class="sd">          of that particular axes</span>
<span class="sd">        * only a minimal set of information to detremine the resampling parameter </span>
<span class="sd">          has to be given, e.g. dataSizeSource and dataSizeSink</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c">#fix (y,x,z) image array representation</span>
    <span class="c">#resolutionSource, resolutionSink = self.fixResolutions(resolutionSource, resolutionSink);</span>
    
    <span class="n">orientation</span> <span class="o">=</span> <span class="n">fixOrientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>

    <span class="c">#datasize of data source</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">dataSize</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">);</span>
    
    <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">resolutionSource</span><span class="p">,</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="n">resampleDataSize</span><span class="p">(</span><span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="n">dataSizeSink</span><span class="p">,</span> 
                                                                                      <span class="n">resolutionSource</span> <span class="o">=</span> <span class="n">resolutionSource</span><span class="p">,</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="n">resolutionSink</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="n">orientation</span><span class="p">);</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readPoints</span><span class="p">(</span><span class="n">pointSource</span><span class="p">);</span>

    <span class="n">dataSizeSinkI</span> <span class="o">=</span> <span class="n">orientDataSizeInverse</span><span class="p">(</span><span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span>
    <span class="c">#resolutionSinkI = orientResolutionInverse(resolutionSink, orientation);</span>
        
    <span class="c">#scaling factors</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">dataSizeSinkI</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)];</span>
    <span class="c">#print scale</span>
    
    <span class="n">repoints</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>    
        <span class="n">repoints</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">repoints</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
               
    <span class="c">#permute for non trivial orientation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">per</span> <span class="o">=</span> <span class="n">orientationToPermuation</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>
        <span class="n">repoints</span> <span class="o">=</span> <span class="n">repoints</span><span class="p">[:,</span><span class="n">per</span><span class="p">];</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">orientation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">repoints</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataSizeSink</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">repoints</span><span class="p">[:,</span><span class="n">i</span><span class="p">];</span>
      
    <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">writePoints</span><span class="p">(</span><span class="n">pointSink</span><span class="p">,</span> <span class="n">repoints</span><span class="p">);</span></div>


     
<div class="viewcode-block" id="resamplePointsInverse"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.resamplePointsInverse">[docs]</a><span class="k">def</span> <span class="nf">resamplePointsInverse</span><span class="p">(</span><span class="n">pointSource</span><span class="p">,</span> <span class="n">pointSink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">resolutionSource</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0625</span><span class="p">,</span> <span class="mf">4.0625</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resample points from the coordinates of the resampled image to the original data</span>

<span class="sd">    The resampling of points here corresponds to he resampling of an image in :func:`resampleDataInverse`</span>
<span class="sd">        </span>
<span class="sd">    Arguments:</span>
<span class="sd">        pointSource (str or array): image to be resampled</span>
<span class="sd">        pointSink (str or None): destination of resampled image</span>
<span class="sd">        orientation (tuple): orientation specified by permuation and change in sign of (1,2,3)</span>
<span class="sd">        dataSizeSource (str, tuple or None): size of the data source</span>
<span class="sd">        dataSizeSink (str, tuple or None): target size of the resampled image</span>
<span class="sd">        resolutionSource (tuple): resolution of the source image (in length per pixel)</span>
<span class="sd">        resolutionSink (tuple): resolution of the resampled image (in length per pixel)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        (array or str): data or file name of inversely resampled points</span>

<span class="sd">    Notes: </span>
<span class="sd">        * resolutions are assumed to be given for the axes of the intrinsic </span>
<span class="sd">          orientation of the data and reference as when viewed by matplotlib or ImageJ</span>
<span class="sd">        * orientation: permuation of 1,2,3 with potential sign, indicating which </span>
<span class="sd">          axes map onto the reference axes, a negative sign indicates reversal </span>
<span class="sd">          of that particular axes</span>
<span class="sd">        * only a minimal set of information to detremine the resampling parameter </span>
<span class="sd">          has to be given, e.g. dataSizeSource and dataSizeSink</span>
<span class="sd">    &quot;&quot;&quot;</span>
       
    <span class="n">orientation</span> <span class="o">=</span> <span class="n">fixOrientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>
    
    <span class="c">#datasize of data source</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">dataSize</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">);</span>
    
    <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">resolutionSource</span><span class="p">,</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="n">resampleDataSize</span><span class="p">(</span><span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="n">dataSizeSink</span><span class="p">,</span> 
                                                                                      <span class="n">resolutionSource</span> <span class="o">=</span> <span class="n">resolutionSource</span><span class="p">,</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="n">resolutionSink</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="n">orientation</span><span class="p">);</span>
            
    <span class="n">points</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readPoints</span><span class="p">(</span><span class="n">pointSource</span><span class="p">);</span>
    
    <span class="n">dataSizeSinkI</span> <span class="o">=</span> <span class="n">orientDataSizeInverse</span><span class="p">(</span><span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">orientation</span><span class="p">);</span>
    <span class="c">#resolutionSinkI = orientResolutionInverse(resolutionSink, orientation);</span>
        
    <span class="c">#scaling factors</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">dataSizeSource</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">dataSizeSinkI</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)];</span>
    <span class="c">#print scale</span>

    <span class="n">rpoints</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>    
    
    <span class="c">#invert axis inversion and permutations    </span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">orientation</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">#invert permuation</span>
        <span class="n">iorientation</span> <span class="o">=</span> <span class="n">inverseOrientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">);</span>
        <span class="n">per</span> <span class="o">=</span> <span class="n">orientationToPermuation</span><span class="p">(</span><span class="n">iorientation</span><span class="p">);</span>
        <span class="n">rpoints</span> <span class="o">=</span> <span class="n">rpoints</span><span class="p">[:,</span><span class="n">per</span><span class="p">];</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">iorientation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rpoints</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataSizeSink</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">rpoints</span><span class="p">[:,</span><span class="n">i</span><span class="p">];</span>
    
    <span class="c">#scale points</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>   
        <span class="n">rpoints</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpoints</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>    
    
    <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">writePoints</span><span class="p">(</span><span class="n">pointSink</span><span class="p">,</span> <span class="n">rpoints</span><span class="p">);</span></div>



<div class="viewcode-block" id="sagittalToCoronalData"><a class="viewcode-back" href="../../../api/ClearMap.Alignment.html#ClearMap.Alignment.Resampling.sagittalToCoronalData">[docs]</a><span class="k">def</span> <span class="nf">sagittalToCoronalData</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change from saggital to coronal orientation</span>
<span class="sd">     </span>
<span class="sd">    Arguments:</span>
<span class="sd">        source (str or array): source data to be reoriented</span>
<span class="sd">        sink (str or None): destination for reoriented image</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        str or array: reoriented data</span>
<span class="sd">    &quot;&quot;&quot;</span>
      
    <span class="n">source</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readData</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;sagittalToCoronalData: 3d image required!&#39;</span><span class="p">);</span>
    
    <span class="n">tp</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
    <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="c">#source = source[::-1,:,:];</span>
    <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">writeData</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span></div>




<span class="k">def</span> <span class="nf">_test</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Tests for the Resampling Module&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ClearMap.Alignment.Resampling</span> <span class="kn">as</span> <span class="nn">self</span>
    <span class="nb">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">ClearMap.Settings</span> <span class="kn">import</span> <span class="n">ClearMapPath</span> <span class="k">as</span> <span class="n">basedir</span> 
    <span class="kn">import</span> <span class="nn">iDISCO.IO.IO</span> <span class="kn">as</span> <span class="nn">io</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">numpy</span>

    <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s">&#39;Test/Data/OME/16-17-27_0_8X-s3-20HF_UltraII_C00_xyz-Table Z\d{4}.ome.tif&#39;</span><span class="p">);</span>
    <span class="n">outfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s">&quot;Test/Data/Resampling/test.mhd&quot;</span><span class="p">)</span>
    
    <span class="k">print</span> <span class="s">&quot;Making resampled stack &quot;</span> <span class="o">+</span> <span class="n">outfn</span>
    <span class="k">print</span> <span class="s">&quot;source datasize </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">dataSize</span><span class="p">(</span><span class="n">fn</span><span class="p">));</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resampleData</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">resolutionSource</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
    <span class="k">print</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">io</span><span class="o">.</span><span class="n">writeData</span><span class="p">(</span><span class="n">outfn</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>   

    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resampleData</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
    <span class="k">print</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">io</span><span class="o">.</span><span class="n">writeData</span><span class="p">(</span><span class="n">outfn</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>   


    <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">resolutionSource</span><span class="p">,</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resampleDataSize</span><span class="p">(</span><span class="n">dataSizeSource</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span> <span class="mi">303</span><span class="p">),</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> 
                                                                                      <span class="n">resolutionSource</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">resolutionSink</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>

    <span class="k">print</span> <span class="n">dataSizeSource</span><span class="p">,</span> <span class="n">dataSizeSink</span><span class="p">,</span> <span class="n">resolutionSource</span><span class="p">,</span> <span class="n">resolutionSink</span>
    

    <span class="n">points</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">io</span><span class="o">.</span><span class="n">dataSize</span><span class="p">(</span><span class="n">fn</span><span class="p">)]);</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resamplePoints</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">fn</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">print</span> <span class="n">pr</span>

    <span class="n">pri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resamplePointsInverse</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">fn</span><span class="p">,</span> <span class="n">dataSizeSink</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">print</span> <span class="n">pri</span>


    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resampleDataInverse</span><span class="p">(</span><span class="n">outfn</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s">&#39;Test/Data/OME/resample_\d{4}.ome.tif&#39;</span><span class="p">),</span> <span class="n">dataSizeSource</span> <span class="o">=</span> <span class="n">fn</span><span class="p">);</span>
    <span class="k">print</span> <span class="n">result</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">_test</span><span class="p">();</span>
    




<span class="c">#    </span>
<span class="c">#def dataSize(imageFilePattern):</span>
<span class="c">#    &quot;&quot;&quot;Determine full size from raw data in (x,y,z) order (not the array format (y,x,z))&quot;&quot;&quot;</span>
<span class="c">#</span>
<span class="c">#    if os.path.exists(imageFilePattern): # single file</span>
<span class="c">#        tf = tiff.TiffFile(imageFilePattern);</span>
<span class="c">#        shape = tf.series[0][&#39;shape&#39;];</span>
<span class="c">#        return (shape[1], shape[2], shape[0])</span>
<span class="c">#    </span>
<span class="c">#    imageDirectory, listOfImages = self.readFileList(imageFilePattern);</span>
<span class="c">#    nz = len(listOfImages);</span>
<span class="c">#    </span>
<span class="c">#    if nz == 0:</span>
<span class="c">#        raise RuntimeError(&quot;dataSize: no files match: %s&quot; % imageFilePattern);</span>
<span class="c">#    </span>
<span class="c">#    imagefile = os.path.join(imageDirectory, listOfImages[0]);</span>
<span class="c">#    sagittalImage = plt.imread(imagefile);# reads as y-x</span>
<span class="c">#    </span>
<span class="c">#    return  (sagittalImage.shape[1], sagittalImage.shape[0], nz)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
       <li><a href="../../../index.html">home</a>|&nbsp;</li>
       <li><a href="../../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../../api/ClearMap.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016 Christoph Kirst.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.3.
    </div>
  </body>
</html>